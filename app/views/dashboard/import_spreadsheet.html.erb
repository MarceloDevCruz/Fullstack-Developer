<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 m-0"><%= t('views.dashboard.import_spreadsheet.title') %></h1>
        <%= link_to root_path, class: 'btn btn-outline-light btn-sm d-flex align-items-center gap-2' do %>
          <span aria-hidden="true">←</span>
          <span><%= t('views.dashboard.back_to_home') %></span>
        <% end %>
      </div>
      <div class="card mb-3">
        <div class="card-body">
          <p class="text-muted mb-3"><%= t('views.dashboard.import_spreadsheet.instructions') %></p>
          <div class="d-flex align-items-center gap-2 mb-3">
            <a class="btn btn-outline-secondary" href="/spreadsheets/planilha_modelo.xlsx" download>
              <%= t('views.dashboard.import_spreadsheet.download_template') %>
            </a>
            <small class="text-muted"><%= t('views.dashboard.import_spreadsheet.columns.title') %> <code><%= t('views.dashboard.import_spreadsheet.columns.full_name') %></code>, <code><%= t('views.dashboard.import_spreadsheet.columns.email') %></code>, <code><%= t('views.dashboard.import_spreadsheet.columns.role') %></code> <%= t('views.dashboard.import_spreadsheet.columns.roles') %></small>
          </div>
          <div class="d-flex align-items-center gap-2 mb-3">
            <a class="btn btn-outline-secondary" href="/spreadsheets/teste_de_carga.xlsx" download>
              <%= t('views.dashboard.import_spreadsheet.download_test') %>
            </a>
          </div>

          <%= form_with url: import_spreadsheet_upload_path, method: :post, multipart: true, local: true do %>
            <%= hidden_field_tag :token, @token %>
            <div class="mb-3">
              <label class="form-label"><%= t('views.dashboard.import_spreadsheet.label') %></label>
              <%= file_field_tag :csv_file,
                  accept: ".csv,.xlsx,.xls,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel",
                  class: "form-control" %>
            </div>
            <button class="btn btn-success" type="submit"><%= t('views.dashboard.import_spreadsheet.upload_button') %></button>
          <% end %>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong><%= t('views.dashboard.import_spreadsheet.progress') %></strong>
            <small class="text-muted"><%= t('views.dashboard.import_spreadsheet.action_cable') %></small>
          </div>
          <div class="progress mb-2" style="height: 20px;">
            <div id="importProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%;">0%</div>
          </div>
          <pre id="importLog" class="form-control" style="height: 220px; overflow: auto;"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script type="module">
  import * as ActionCable from "https://cdn.skypack.dev/@rails/actioncable";
  const consumer = ActionCable.createConsumer("/cable");
  const token = "<%= @token %>";
  const $jq = window.jQuery;

  $jq(function() {
    const $progress = $jq('#importProgress');
    const $log = $jq('#importLog');

    function setProgress(cur, total) {
      if (!total) return;
      const pct = Math.round((cur / total) * 100);
      $progress.css('width', pct + '%').text(pct + '%');
    }

    function log(msg) {
      $log.append(msg + "\n");
      $log.scrollTop($log[0].scrollHeight);
    }

    $jq('form').on('submit', function() {
      const $btn = $jq(this).find('button[type="submit"]');
      if (!$btn.data('original-text')) {
        $btn.data('original-text', $btn.text());
      }
      if (!$btn.data('original-classes')) {
        $btn.data('original-classes', $btn.attr('class'));
      }
      $btn.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary').text('Enviando...');
    });

    consumer.subscriptions.create({ channel: 'ImportSpreadsheetChannel', token }, {
      received(data) {
        if (data.type === 'start') {
          setProgress(0, data.total);
          log(`Iniciando. Total: ${data.total}`);
        } else if (data.type === 'progress') {
          setProgress(data.current, data.total);
          log(`${data.ok ? '✔' : '✖'} (${data.current}/${data.total}) ${data.message}`);
        } else if (data.type === 'finished') {
          setProgress(data.total, data.total);
          log(`Concluído. Importados: ${data.imported}, Falharam: ${data.failed}`);
          if (data.errors?.length) log('Erros:\n- ' + data.errors.join('\n- '));
          const $btn = $jq('form').find('button[type="submit"]');
          const originalText = $btn.data('original-text') || '<%= j t('views.dashboard.import_spreadsheet.upload_button') %>';
          $btn.prop('disabled', false)
              .removeClass('btn-secondary')
              .addClass('btn-success')
              .text(originalText);
        } else {
          log(JSON.stringify(data));
        }
      }
    });
  });
</script>
